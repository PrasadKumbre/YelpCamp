<% /* ---------- IF USER IS LOGGED-IN ---------- */ %>
    <% if (currentUser) { %>
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="reviewTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="view-tab" data-bs-toggle="tab" data-bs-target="#viewReviews"
                    type="button" role="tab">
                    <i class="bi bi-eye-fill me-1"></i> View Reviews
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="write-tab" data-bs-toggle="tab" data-bs-target="#writeReview" type="button"
                    role="tab">
                    <i class="bi bi-pencil-square me-1"></i> Write Review
                </button>
            </li>
        </ul>

        <div class="tab-content" id="reviewTabContent">
            <!-- ===== View (LOGGED-IN) ===== -->
            <div class="tab-pane fade show active" id="viewReviews" role="tabpanel">
                <% if (campground.reviews.length===0) { %>
                    <div class="alert alert-info">No reviews yet.</div>
                    <% } %>

                        <div id="reviewContainerLogged" class="reviews-wrapper">
                            <% for (let i=0; i < campground.reviews.length; i++) { %>
                                <div class="card shadow-sm border-0 mb-3 rounded-4 review-card review-item"
                                    style="<%= i >= 3 ? 'display:none;' : '' %>">
                                    <div class="card-body">
                                        <p class="starability-result text-warning"
                                            data-rating="<%= campground.reviews[i].rating %>">
                                            Rated: <%= campground.reviews[i].rating %> Stars.
                                        </p>
                                        <p class="card-text fst-italic">
                                            <%= campground.reviews[i].body %>
                                        </p>
                                        <h6 class="card-subtitle text-muted mb-2">
                                            By - <%= campground.reviews[i].author.username %>
                                        </h6>

                                        <% if (currentUser && campground.reviews[i].author.equals(currentUser._id)) { %>
                                            <form
                                                action="/campgrounds/<%= campground._id %>/reviews/<%= campground.reviews[i]._id %>?_method=DELETE"
                                                method="post">
                                                <button class="btn btn-sm btn-outline-danger rounded-3">
                                                    <i class="bi bi-trash-fill me-1"></i>Delete
                                                </button>
                                            </form>
                                            <% } %>
                                    </div>
                                </div>
                                <% } %>
                        </div>

                        <% if (campground.reviews.length> 3) { %>
                            <div class="d-flex justify-content-center mt-3">
                                <button class="btn btn-outline-primary me-2 prevBtn"
                                    data-container="reviewContainerLogged">Previous</button>
                                <button class="btn btn-outline-primary nextBtn"
                                    data-container="reviewContainerLogged">Next</button>
                            </div>
                            <% } %>
            </div>

            <!-- ===== Write ===== -->
            <div class="tab-pane fade" id="writeReview" role="tabpanel">
                <div class="card shadow-lg border-0 rounded-4 mb-4">
                    <div class="card-body p-4">
                        <h4 class="mb-4 text-success text-center fw-bold">
                            <i class="bi bi-chat-square-dots"></i> Leave a Review
                        </h4>
                        <form action="/campgrounds/<%= campground._id %>/reviews" method="post" class="validated-form"
                            novalidate>
                            <fieldset class="starability-basic mb-4">
                                <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1"
                                    checked />
                                <input type="radio" id="first-rate1" name="review[rating]" value="1" /><label
                                    for="first-rate1" title="Terrible">1 star</label>
                                <input type="radio" id="first-rate2" name="review[rating]" value="2" /><label
                                    for="first-rate2" title="Not good">2 stars</label>
                                <input type="radio" id="first-rate3" name="review[rating]" value="3" /><label
                                    for="first-rate3" title="Average">3 stars</label>
                                <input type="radio" id="first-rate4" name="review[rating]" value="4" /><label
                                    for="first-rate4" title="Very good">4 stars</label>
                                <input type="radio" id="first-rate5" name="review[rating]" value="5" /><label
                                    for="first-rate5" title="Amazing">5 stars</label>
                            </fieldset>

                            <div class="mb-3">
                                <label for="body" class="form-label fw-semibold">Your Review</label>
                                <textarea class="form-control shadow-sm rounded-3" name="review[body]" id="body"
                                    rows="4" required></textarea>
                                <div class="invalid-feedback">Please write your review.</div>
                            </div>

                            <div class="d-grid">
                                <button class="btn btn-success btn-lg rounded-3">
                                    <i class="bi bi-send-fill me-1"></i>Submit Review
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <% /* ---------- IF USER IS NOT LOGGED-IN ---------- */ %>
            <% } else { %>
                <h4 class="mb-3 text-primary">Reviews</h4>
                <% if (campground.reviews.length===0) { %>
                    <div class="alert alert-info">No reviews yet.</div>
                    <% } %>

                        <div id="reviewContainerPublic" class="reviews-wrapper">
                            <% for (let i=0; i < campground.reviews.length; i++) { %>
                                <div class="card shadow-sm border-0 mb-3 rounded-4 review-card review-item"
                                    style="<%= i >= 3 ? 'display:none;' : '' %>">
                                    <div class="card-body">
                                        <p class="starability-result text-warning"
                                            data-rating="<%= campground.reviews[i].rating %>">
                                            Rated: <%= campground.reviews[i].rating %> Stars.
                                        </p>
                                        <p class="card-text fst-italic">
                                            <%= campground.reviews[i].body %>
                                        </p>
                                        <h6 class="card-subtitle text-muted mb-2">
                                            By - <%= campground.reviews[i].author.username %>
                                        </h6>
                                    </div>
                                </div>
                                <% } %>
                        </div>

                        <% if (campground.reviews.length> 3) { %>
                            <div class="d-flex justify-content-center mt-3">
                                <button class="btn btn-outline-primary me-2 prevBtn"
                                    data-container="reviewContainerPublic">Previous</button>
                                <button class="btn btn-outline-primary nextBtn"
                                    data-container="reviewContainerPublic">Next</button>
                            </div>
                            <% } %>
                                <% } %>

                                    <!-- ========== Pagination Script (shared) ========== -->
                                    <script>
                                        // Trim review body on submit (existing code, unchanged)
                                        const reviewForm = document.querySelector('form[action*="/reviews"]');
                                        if (reviewForm) {
                                            reviewForm.addEventListener('submit', function (e) {
                                                const textarea = reviewForm.querySelector('textarea[name="review[body]"]');
                                                textarea.value = textarea.value.trim();
                                            });
                                        }

                                        // Helper to attach pagination to any wrapper
                                        function createPagination(wrapperId, reviewsPerPage = 3) {
                                            const wrapper = document.getElementById(wrapperId);
                                            if (!wrapper) return;

                                            const items = wrapper.querySelectorAll('.review-item');
                                            if (items.length <= reviewsPerPage) return; // no pagination needed

                                            const prevBtn = document.querySelector(`.prevBtn[data-container="${wrapperId}"]`);
                                            const nextBtn = document.querySelector(`.nextBtn[data-container="${wrapperId}"]`);

                                            let currentPage = 0;
                                            const totalPages = Math.ceil(items.length / reviewsPerPage);

                                            function renderPage() {
                                                items.forEach((item, idx) => {
                                                    item.style.display = (idx >= currentPage * reviewsPerPage && idx < (currentPage + 1) * reviewsPerPage) ? 'block' : 'none';
                                                });
                                                if (prevBtn) prevBtn.disabled = currentPage === 0;
                                                if (nextBtn) nextBtn.disabled = currentPage >= totalPages - 1;
                                            }

                                            if (prevBtn && nextBtn) {
                                                prevBtn.addEventListener('click', () => { if (currentPage > 0) { currentPage--; renderPage(); } });
                                                nextBtn.addEventListener('click', () => { if (currentPage < totalPages - 1) { currentPage++; renderPage(); } });
                                            }
                                            renderPage(); // initial render
                                        }

                                        document.addEventListener('DOMContentLoaded', () => {
                                            createPagination('reviewContainerLogged');
                                            createPagination('reviewContainerPublic');
                                        });
                                    </script>